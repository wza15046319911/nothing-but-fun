---
description: 
globs: 
alwaysApply: true
---
# Course Review System API Documentation

This document describes the RESTful API endpoints for the UQ Course Review System, which allows students to review and rate university courses with a built-in moderation system.

## Base URL
```
/api
```

## Authentication
Note: Authentication middleware should be implemented for production use. Some endpoints (like moderation) require admin privileges.

## ⚠️ Important: Default Review Visibility

**Key Behavior Change:** All public review endpoints now return **only approved and visible reviews** by default. This ensures that:

- Students and public users only see moderated, approved content
- Course ratings are calculated based on approved reviews only
- Pending and rejected reviews are hidden from public view
- Admin/moderator endpoints provide full access to all review statuses

**Affected Endpoints:**
- `GET /course-reviews` - Only approved reviews
- `GET /course-reviews/course/:courseId` - Only approved reviews (unless `includeHidden=true` for admins)
- `GET /course-reviews/user/:userId` - Only approved reviews
- Course rating calculations - Based on approved reviews only

---

## Course Endpoints

### 1. Get All Courses
**GET** `/courses`

Retrieve all courses with optional filtering and pagination.

**Query Parameters:**
- `courseCode` (string, optional): Filter by course code (partial match)
- `courseName` (string, optional): Filter by course name (partial match)
- `minRating` (number, optional): Filter courses with minimum rating
- `page` (number, optional): Page number (default: 1)
- `limit` (number, optional): Items per page (default: 10)
- `sortBy` (string, optional): Sort field (`courseCode`, `courseName`, `overallRating`, `totalReviews`, `createdAt`)
- `sortOrder` (string, optional): Sort order (`asc`, `desc`)

**Response:**
```json
{
  "success": true,
  "message": "Courses retrieved successfully",
  "data": [
    {
      "id": 1,
      "courseCode": "COMP3506",
      "courseName": "Algorithms and Data Structures",
      "overallRating": "4.25",
      "totalReviews": 15,
      "createdAt": "2024-01-15T10:30:00Z",
      "updatedAt": "2024-01-20T14:45:00Z"
    }
  ],
  "pagination": {
    "page": 1,
    "limit": 10,
    "total": 25,
    "totalPages": 3,
    "hasNext": true,
    "hasPrev": false
  }
}
```

### 2. Get Course by ID
**GET** `/courses/:id`

Retrieve a specific course by its ID.

**Response:**
```json
{
  "success": true,
  "message": "Course retrieved successfully",
  "data": {
    "id": 1,
    "courseCode": "COMP3506",
    "courseName": "Algorithms and Data Structures",
    "overallRating": "4.25",
    "totalReviews": 15,
    "createdAt": "2024-01-15T10:30:00Z",
    "updatedAt": "2024-01-20T14:45:00Z"
  }
}
```

### 3. Get Course by Course Code
**GET** `/courses/code/:courseCode`

Retrieve a course by its course code (e.g., COMP3506).

**Example:** `GET /courses/code/COMP3506`

### 4. Create Course
**POST** `/courses`

Create a new course.

**Request Body:**
```json
{
  "courseCode": "COMP3506",
  "courseName": "Algorithms and Data Structures"
}
```

**Response:**
```json
{
  "success": true,
  "message": "Course created successfully",
  "data": {
    "id": 1,
    "courseCode": "COMP3506",
    "courseName": "Algorithms and Data Structures",
    "overallRating": "0.00",
    "totalReviews": 0,
    "createdAt": "2024-01-15T10:30:00Z",
    "updatedAt": "2024-01-15T10:30:00Z"
  }
}
```

### 5. Update Course
**PUT** `/courses/:id`

Update an existing course.

**Request Body:**
```json
{
  "courseName": "Advanced Algorithms and Data Structures"
}
```

### 6. Delete Course
**DELETE** `/courses/:id`

Delete a course (only if it has no reviews).

**Response:**
```json
{
  "success": true,
  "message": "Course deleted successfully",
  "data": null
}
```

### 7. Search Courses
**GET** `/courses/search/:keyword`

Search courses by course code or name.

**Example:** `GET /courses/search/comp`

### 8. Get Top Rated Courses
**GET** `/courses/top-rated`

Get top-rated courses.

**Query Parameters:**
- `limit` (number, optional): Number of courses to return (1-50, default: 10)

### 9. Get Courses by Department
**GET** `/courses/department/:department`

Get all courses from a specific department.

**Example:** `GET /courses/department/COMP`

### 10. Update Course Rating
**POST** `/courses/:id/update-rating`

Manually update course rating statistics (admin only).

---

## Course Review Endpoints

### 1. Get All Reviews (Public) - ⚠️ Currently Disabled
**GET** `/course-reviews`

**Status: DISABLED** - This endpoint is currently commented out in the routes for security reasons.

Retrieve all **approved and visible** reviews with optional filtering and pagination.

**⚠️ Important:** This endpoint only returns reviews that have been approved by moderators and are visible to the public. For admin access to all reviews (including pending/rejected), use the admin endpoints.

**Query Parameters:**
- `courseId` (number, optional): Filter by course ID
- `userId` (number, optional): Filter by user ID
- `minRating` (number, optional): Filter by minimum rating
- `maxRating` (number, optional): Filter by maximum rating
- `page` (number, optional): Page number (default: 1)
- `limit` (number, optional): Items per page (default: 10)
- `sortBy` (string, optional): Sort field (`rating`, `createdAt`, `moderatedAt`)
- `sortOrder` (string, optional): Sort order (`asc`, `desc`)

**Note:** The following parameters are automatically set and cannot be overridden:
- `moderationStatus`: Always set to `approved`
- `isVisible`: Always set to `true`

**Response:**
```json
{
  "success": true,
  "message": "Reviews retrieved successfully",
  "data": [
    {
      "id": 1,
      "courseId": 1,
      "userId": 123,
      "username": "john_doe",
      "rating": 5,
      "content": "Excellent course! Really enjoyed the practical assignments.",
      "moderationStatus": "approved",
      "isVisible": true,
      "moderatedBy": 456,
      "moderatedAt": "2024-01-16T09:15:00Z",
      "rejectionReason": null,
      "createdAt": "2024-01-15T14:30:00Z",
      "updatedAt": "2024-01-16T09:15:00Z",
      "courseCode": "COMP3506",
      "courseName": "Algorithms and Data Structures"
    }
  ],
  "pagination": {
    "page": 1,
    "limit": 10,
    "total": 50,
    "totalPages": 5,
    "hasNext": true,
    "hasPrev": false
  }
}
```

### 2. Get Review by ID
**GET** `/course-reviews/:id`

Retrieve a specific review by its ID.

### 3. Get Reviews by Course
**GET** `/course-reviews/course/:courseId`

Get all **approved and visible** reviews for a specific course.

**⚠️ Important:** This endpoint only returns approved reviews by default. Hidden/rejected reviews are not included unless explicitly requested by admin users.

**Query Parameters:**
- `includeHidden` (boolean, optional): Include hidden/rejected reviews (admin only, default: false)
- Standard pagination parameters (`page`, `limit`, `sortBy`, `sortOrder`)

### 4. Get Reviews by User - ⚠️ Currently Disabled
**GET** `/course-reviews/user/:userId`

**Status: DISABLED** - This endpoint is currently commented out in the routes.

Get all **approved and visible** reviews by a specific user.

**⚠️ Important:** This endpoint only returns approved reviews by default. To see all reviews by a user (including pending/rejected), admin access is required.

### 5. Get Pending Reviews - ⚠️ Currently Disabled
**GET** `/course-reviews/pending`

**Status: DISABLED** - This endpoint is currently commented out in the routes.

Get all reviews pending moderation (admin only).

### 6. Create Review
**POST** `/course-reviews`

Create a new course review.

**Request Body:**
```json
{
  "courseId": 1,
  "userId": 123,
  "username": "john_doe",
  "rating": 5,
  "content": "Excellent course! The professor explains concepts clearly and the assignments are challenging but fair."
}
```

**Response:**
```json
{
  "success": true,
  "message": "Review created successfully and is pending moderation",
  "data": {
    "id": 1,
    "courseId": 1,
    "userId": 123,
    "username": "john_doe",
    "rating": 5,
    "content": "Excellent course! The professor explains concepts clearly...",
    "moderationStatus": "pending",
    "isVisible": false,
    "moderatedBy": null,
    "moderatedAt": null,
    "rejectionReason": null,
    "createdAt": "2024-01-15T14:30:00Z",
    "updatedAt": "2024-01-15T14:30:00Z"
  }
}
```

### 7. Update Review
**PUT** `/course-reviews/:id`

Update an existing review (only content and rating).

**Request Body:**
```json
{
  "rating": 4,
  "content": "Updated review content after taking the course again."
}
```

**Note:** Updating a review resets its moderation status to "pending".

### 8. Delete Review
**DELETE** `/course-reviews/:id`

Delete a review.

### 9. Moderate Review - ⚠️ Currently Disabled
**POST** `/course-reviews/:id/moderate`

**Status: DISABLED** - This endpoint is currently commented out in the routes.

Approve or reject a review (admin/moderator only).

**Request Body:**
```json
{
  "action": "approve",
  "moderatorId": 456,
  "rejectionReason": null
}
```

For rejection:
```json
{
  "action": "reject",
  "moderatorId": 456,
  "rejectionReason": "Contains inappropriate language"
}
```

**Response:**
```json
{
  "success": true,
  "message": "Review approved successfully",
  "data": {
    "id": 1,
    "moderationStatus": "approved",
    "isVisible": true,
    "moderatedBy": 456,
    "moderatedAt": "2024-01-16T09:15:00Z",
    "rejectionReason": null,
    "updatedAt": "2024-01-16T09:15:00Z"
  }
}
```

### 10. Get Course Review Statistics - ⚠️ Currently Disabled
**GET** `/course-reviews/course/:courseId/stats`

**Status: DISABLED** - This endpoint is currently commented out in the routes.

Get detailed statistics for a course's reviews.

**Response:**
```json
{
  "success": true,
  "message": "Course review statistics retrieved successfully",
  "data": {
    "totalReviews": 25,
    "averageRating": 4.2,
    "ratingDistribution": {
      "5": 8,
      "4": 10,
      "3": 5,
      "2": 2,
      "1": 0
    }
  }
}
```

### 11. Get Moderation Statistics - ⚠️ Currently Disabled
**GET** `/course-reviews/moderation/stats`

**Status: DISABLED** - This endpoint is currently commented out in the routes.

Get overall moderation statistics (admin only).

**Response:**
```json
{
  "success": true,
  "message": "Moderation statistics retrieved successfully",
  "data": {
    "pending": 15,
    "approved": 120,
    "rejected": 8,
    "total": 143
  }
}
```

---

## Admin-Only Endpoints

The following endpoints are available for administrators and moderators to access all reviews regardless of moderation status:

### Get All Reviews (Admin)
**GET** `/admin/course-reviews`

Retrieve all reviews including pending, approved, and rejected reviews with full filtering capabilities.

**Query Parameters:**
- All standard filtering parameters
- `moderationStatus` (string, optional): Filter by moderation status (`pending`, `approved`, `rejected`)
- `isVisible` (boolean, optional): Filter by visibility status

**Note:** This endpoint requires admin authentication and provides access to all reviews regardless of their moderation status.

---

## Error Responses

All endpoints return consistent error responses:

```json
{
  "success": false,
  "message": "Error description",
  "data": null
}
```

**Common HTTP Status Codes:**
- `200` - Success
- `201` - Created
- `400` - Bad Request (validation errors)
- `404` - Not Found
- `409` - Conflict (duplicate data, business rule violations)
- `500` - Internal Server Error

---

## Business Rules

### Course Management
1. Course codes must be unique and follow the format: 4 letters + 4 digits (e.g., COMP3506)
2. Course codes are automatically converted to uppercase
3. Courses with existing reviews cannot be deleted
4. Rating statistics are automatically updated when reviews are approved/rejected

### Review System
1. Users can only submit one review per course
2. All reviews start with "pending" moderation status and are not visible to the public
3. **Only approved reviews are visible to the public and count toward course ratings**
4. **Public endpoints (non-admin) only return approved and visible reviews by default**
5. Updating a review resets its moderation status to "pending" and makes it invisible again
6. Reviews must have ratings between 1-5 (integers only)
7. Review content is limited to 2000 characters
8. Admin/moderator endpoints can access all reviews regardless of status

### Moderation System
1. Reviews require moderation before becoming visible
2. Rejected reviews must include a rejection reason
3. Once moderated, reviews cannot be moderated again
4. Course rating statistics are updated automatically when reviews are approved

---

## Usage Examples

### Creating a Course and Review Flow

1. **Create a course:**
```bash
POST /api/courses
{
  "courseCode": "COMP3506",
  "courseName": "Algorithms and Data Structures"
}
```

2. **Submit a review:**
```bash
POST /api/course-reviews
{
  "courseId": 1,
  "userId": 123,
  "username": "student123",
  "rating": 5,
  "content": "Great course with excellent practical assignments!"
}
```

3. **Moderate the review (admin):**
```bash
POST /api/course-reviews/1/moderate
{
  "action": "approve",
  "moderatorId": 456
}
```

4. **Check updated course statistics:**
```bash
GET /api/courses/1
```

The course's `overallRating` and `totalReviews` will be automatically updated after review approval. 