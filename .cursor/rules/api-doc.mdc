---
alwaysApply: true
---
# Nothing But Fun Backend API Documentation

## Overview
This document provides comprehensive documentation for the Nothing But Fun backend API. The API serves a WeChat Mini Program that provides various services including events, rental houses, peripheral items, course reviews, restaurant reviews, secondhand items, and carpool services.

**Base URL**: `/api`

## Authentication
Most endpoints are currently public. WeChat authentication is available through the `/login` endpoint. Some admin endpoints may require authentication (noted in individual endpoint descriptions).

## Common Response Format
Most endpoints follow a consistent response format:
```json
{
  "success": boolean,
  "message": string,
  "data": object | array,
  "pagination": {
    "page": number,
    "limit": number,
    "total": number,
    "totalPages": number,
    "hasNext": boolean,
    "hasPrev": boolean
  }
}
```

## Special Features
- **Image Aggregation**: Events, rental houses, and peripheral items support multiple images through Directus file management
- **Filtering & Pagination**: Most list endpoints support filtering and pagination
- **File Upload**: Supports image uploads through Directus integration
- **Moderation System**: Reviews require approval before being publicly visible

---

## 1. Events

### 1.1 Get All Events
- **Endpoint**: `GET /events`
- **Description**: Retrieve all events with optional filtering and pagination
- **Query Parameters**:
  - `isHistorical` (boolean): Filter historical (past) or future events
  - `event_type` (string): Filter by event type ID
  - `priceFrom` (number): Minimum price filter
  - `priceTo` (number): Maximum price filter
  - `page` (integer, default: 1): Page number
  - `limit` (integer, default: 10): Items per page
- **Response**: List of events with pagination metadata and aggregated images
- **Special Features**: Returns `imageUrls` array with Cloudinary URLs

### 1.2 Get Event by ID
- **Endpoint**: `GET /events/{id}`
- **Description**: Get detailed information about a specific event
- **Path Parameters**:
  - `id` (integer): Event ID
- **Response**: Event details with aggregated images

### 1.3 Get Event Types
- **Endpoint**: `GET /events/types`
- **Description**: Get all available event types
- **Response**: Array of event type objects with id and name

---

## 2. Event Registrations

### 2.1 Get User Events
- **Endpoint**: `GET /events/register/{userId}`
- **Description**: Get all events registered by a specific user
- **Path Parameters**:
  - `userId` (integer): User ID

### 2.2 Register for Event
- **Endpoint**: `POST /events/register/{eventId}/{userId}`
- **Description**: Register a user for an event
- **Path Parameters**:
  - `eventId` (integer): Event ID
  - `userId` (integer): User ID

### 2.3 Update Registration
- **Endpoint**: `PUT /events/register/{eventId}/{userId}`
- **Description**: Update an existing event registration

### 2.4 Cancel Registration
- **Endpoint**: `DELETE /users/{userId}/events/{eventId}`
- **Description**: Cancel an event registration

---

## 3. Rental Houses

### 3.1 Get All Rental Houses
- **Endpoint**: `GET /rental-houses`
- **Description**: Get all rental houses with filtering and pagination
- **Query Parameters**:
  - `page`, `limit`: Pagination
  - `sortBy`: Sort field (weeklyPrice, createdAt, viewCount)
  - `sortOrder`: asc or desc
  - `suburb` (string): Filter by suburb
  - `minPrice`, `maxPrice` (number): Price range filter
  - `bedrooms`, `bathrooms` (integer): Room count filters
  - `propertyType` (string): Property type filter
  - `furnished` (boolean): Furnished status
  - `petsAllowed` (boolean): Pet policy
  - `smokingAllowed` (boolean): Smoking policy
  - `status` (string): Rental status
- **Response**: List of rental houses with aggregated images
- **Special Features**: Returns `imageUrls` array, property configuration

### 3.2 Get Rental House by ID
- **Endpoint**: `GET /rental-houses/{id}`
- **Description**: Get detailed information about a specific rental house
- **Path Parameters**:
  - `id` (integer): Rental house ID
- **Response**: Rental house details with aggregated images

---

## 4. Peripheral Items

### 4.1 Get All Peripheral Items
- **Endpoint**: `GET /peripherals`
- **Description**: Get all peripheral items
- **Response**: List of peripheral items with aggregated images
- **Special Features**: Returns `imageUrls` array with Cloudinary URLs

### 4.2 Get Peripheral Item by ID
- **Endpoint**: `GET /peripherals/{id}`
- **Description**: Get detailed information about a specific peripheral item
- **Path Parameters**:
  - `id` (integer): Peripheral item ID
- **Response**: Peripheral item details with aggregated images

---

## 5. Course Reviews (RESTful API)

### 5.1 Get Course Reviews
- **Endpoint**: `GET /courses/{courseId}/reviews`
- **Description**: Get all reviews for a specific course
- **Path Parameters**:
  - `courseId` (integer): Course ID
- **Response**: Array of course reviews with boolean rating fields

### 5.2 Get Specific Course Review
- **Endpoint**: `GET /courses/{courseId}/reviews/{reviewId}`
- **Description**: Get a specific review for a course
- **Path Parameters**:
  - `courseId` (integer): Course ID
  - `reviewId` (integer): Review ID
- **Response**: Single course review details

### 5.3 Create Course Review
- **Endpoint**: `POST /courses/{courseId}/reviews`
- **Description**: Create a new review for a course
- **Path Parameters**:
  - `courseId` (integer): Course ID
- **Request Body**:
```json
{
  "easy_pass": boolean,
  "easy_high_distinction": boolean,
  "luck": boolean,
  "recommended": boolean,
  "comment": string (optional)
}
```
- **Response**: Created review (pending moderation)

---

## 6. Courses

### 6.1 Get All Courses
- **Endpoint**: `GET /courses`
- **Description**: Get all available courses

### 6.2 Get Course by ID
- **Endpoint**: `GET /courses/{id}`
- **Description**: Get detailed information about a specific course

### 6.3 Rate Course
- **Endpoint**: `POST /courses/rate/{id}`
- **Description**: Submit a rating for a course

### 6.4 Update Course Rating
- **Endpoint**: `POST /courses/{id}/update-rating`
- **Description**: Update the overall rating for a course

---

## 7. Secondhand Items

### 7.1 Get All Secondhand Items
- **Endpoint**: `GET /secondhand`
- **Description**: Retrieve all approved secondhand items with optional filtering and pagination
- **Query Parameters**:
  - `priceFrom` (number): Minimum price filter
  - `priceTo` (number): Maximum price filter
  - `page` (integer, default: 1): Page number
  - `limit` (integer, default: 10): Items per page
- **Response**: List of secondhand items with pagination metadata and aggregated images
- **Special Features**: Returns `imageUrls` array with Cloudinary URLs

### 7.2 Get Secondhand Item by ID
- **Endpoint**: `GET /secondhand/{id}`
- **Description**: Retrieve a specific secondhand item by ID
- **Parameters**: `id` (integer) - Item ID
- **Response**: Secondhand item details with aggregated images
- **Special Features**: Returns `imageUrls` array with Cloudinary URLs

### 7.3 Create Secondhand Item (Basic)
- **Endpoint**: `POST /secondhand`
- **Description**: Create a new secondhand item without images
- **Request Body**:
  ```json
  {
    "sellerId": 1,
    "title": "iPhone 13",
    "description": "Good condition iPhone 13",
    "price": "800.00",
    "status": "available"
  }
  ```
- **Response**: Created item with ID

### 7.4 Create Secondhand Item with Images
- **Endpoint**: `POST /secondhand/with-images`
- **Description**: Create a new secondhand item with multiple images
- **Content-Type**: `multipart/form-data`
- **Form Data**:
  - `sellerId` (number): Seller's user ID
  - `title` (string): Item title (max 200 characters)
  - `description` (string, optional): Item description
  - `price` (string/number): Item price
  - `status` (string, optional): Item status ('available', 'sold', 'reserved')
  - `images` (files): Multiple image files (max 10 files)
- **Response**:
  ```json
  {
    "success": true,
    "message": "创建二手商品成功",
    "data": {
      "id": 123,
      "uploadedFiles": 3
    }
  }
  ```
- **Special Features**: 
  - Uploads images to Directus file management system
  - Automatically links images to the item
  - Images are accessible via Cloudinary CDN
  - Items are created with 'pending' review status

### 7.5 Upload Single Image
- **Endpoint**: `POST /secondhand/upload`
- **Description**: Upload a single image to Cloudinary
- **Content-Type**: `multipart/form-data`
- **Form Data**: `image` (file)
- **Response**: Cloudinary upload result

### 7.6 Get User's Items
- **Endpoint**: `GET /secondhand/{userId}`
- **Description**: Get all secondhand items by a specific seller
- **Parameters**: `userId` (integer) - Seller's user ID
- **Response**: List of seller's items with aggregated images

---

## 8. Restaurants

### 8.1 Get All Restaurants
- **Endpoint**: `GET /restaurants`
- **Description**: Get all restaurants

### 8.2 Get Restaurant by ID
- **Endpoint**: `GET /restaurants/{id}`
- **Description**: Get detailed information about a specific restaurant

### 8.3 Get Restaurant Types
- **Endpoint**: `GET /restaurants/types`
- **Description**: Get all available restaurant types
- **Response**: Array of restaurant type objects with id and name

### 8.4 Get Price Ranges
- **Endpoint**: `GET /restaurants/price-ranges`
- **Description**: Get all available price ranges
- **Response**: Array of price range objects with id and name

### 8.5 Rate Restaurant
- **Endpoint**: `POST /restaurants/rate/{id}`
- **Description**: Submit a rating for a restaurant

---

## 9. Restaurant Reviews

### 9.1 Get All Reviews
- **Endpoint**: `GET /restaurant-reviews`
- **Description**: Get all restaurant reviews with filtering and pagination
- **Query Parameters**: page, limit, sortBy, sortOrder, restaurantId, userId, minRating, maxRating, status

### 9.2 Get Pending Reviews (Admin)
- **Endpoint**: `GET /restaurant-reviews/pending`
- **Description**: Get reviews pending moderation
- **Access**: Admin only

### 9.3 Get Moderation Stats (Admin)
- **Endpoint**: `GET /restaurant-reviews/moderation/stats`
- **Description**: Get moderation statistics
- **Access**: Admin only

### 9.4 Get Restaurant Review Stats
- **Endpoint**: `GET /restaurant-reviews/restaurant/{restaurantId}/stats`
- **Description**: Get review statistics for a specific restaurant

### 9.5 Get Reviews by Restaurant
- **Endpoint**: `GET /restaurant-reviews/restaurant/{restaurantId}`
- **Description**: Get all reviews for a specific restaurant

### 9.6 Get Approved Reviews by Restaurant
- **Endpoint**: `GET /restaurant-reviews/restaurant/{restaurantId}/approved`
- **Description**: Get only approved reviews for a restaurant (public view)

### 9.7 Get Reviews by User
- **Endpoint**: `GET /restaurant-reviews/user/{userId}`
- **Description**: Get all reviews by a specific user

### 9.8 Get Review by ID
- **Endpoint**: `GET /restaurant-reviews/{id}`
- **Description**: Get a specific review by ID

### 9.9 Create Review
- **Endpoint**: `POST /restaurant-reviews`
- **Description**: Create a new restaurant review
- **Access**: Requires authentication

### 9.10 Update Review
- **Endpoint**: `PUT /restaurant-reviews/{id}`
- **Description**: Update an existing review
- **Access**: Requires authentication

### 9.11 Delete Review
- **Endpoint**: `DELETE /restaurant-reviews/{id}`
- **Description**: Delete a review
- **Access**: Requires authentication

### 9.12 Moderate Review (Admin)
- **Endpoint**: `POST /restaurant-reviews/{id}/moderate`
- **Description**: Approve or reject a review
- **Request Body**: `{ "action": "approve" | "reject" }`
- **Access**: Admin only

---

## 10. Carpool

### 10.1 Get All Carpool Posts
- **Endpoint**: `GET /carpools`
- **Description**: Get all carpool posts

### 10.2 Get Carpool Post by ID
- **Endpoint**: `GET /carpools/{id}`
- **Description**: Get detailed information about a specific carpool post

### 10.3 Create Carpool Post
- **Endpoint**: `POST /carpools/{userId}`
- **Description**: Create a new carpool post
- **Path Parameters**:
  - `userId` (integer): User ID of the poster

### 10.4 Update Carpool Post
- **Endpoint**: `PUT /carpools/{userId}/{id}`
- **Description**: Update an existing carpool post

### 10.5 Delete Carpool Post
- **Endpoint**: `DELETE /carpools/{userId}/{id}`
- **Description**: Delete a carpool post

---

## 11. WeChat Authentication

### 11.1 WeChat Login
- **Endpoint**: `POST /login`
- **Description**: Authenticate user with WeChat Mini Program
- **Request Body**:
```json
{
  "code": "string",
  "userInfo": {
    "nickname": "string",
    "avatarUrl": "string",
    "gender": "string",
    "city": "string",
    "province": "string",
    "country": "string",
    "language": "string"
  }
}
```
- **Response**: User data and JWT token

### 11.2 Create User
- **Endpoint**: `POST /user`
- **Description**: Create a new user account
- **Request Body**: User information including openid

### 11.3 Get User Info
- **Endpoint**: `GET /user/{openid}`
- **Description**: Get user information by WeChat openid

### 11.4 Update Profile
- **Endpoint**: `PUT /profile`
- **Description**: Update user profile information
- **Authentication**: Required

---

## 12. File Management

### 12.1 Upload File
- **Endpoint**: `POST /file`
- **Description**: Upload a file to Directus
- **Content-Type**: `multipart/form-data`
- **Form Data**: `image` (file)
- **Response**: File information including Directus file ID

---

## Error Responses

### Common HTTP Status Codes
- `200`: Success
- `201`: Created
- `400`: Bad Request
- `401`: Unauthorized
- `404`: Not Found
- `409`: Conflict
- `500`: Internal Server Error

### Error Response Format
```json
{
  "success": false,
  "message": "Error description",
  "data": null
}
```

---

## Notes

1. **Image Aggregation**: Events, rental houses, and peripheral items now support multiple images through the Directus file management system. These endpoints return an `imageUrls` array containing full Cloudinary URLs.

2. **Moderation System**: Course reviews and restaurant reviews require moderation before being publicly visible. New reviews are created with "pending" status.

3. **Pagination**: Most list endpoints support pagination with `page` and `limit` parameters. Responses include pagination metadata.

4. **Filtering**: Many endpoints support various filtering options. Check individual endpoint documentation for available filters.

5. **Authentication**: While most endpoints are currently public, some admin endpoints and user-specific actions require authentication. The WeChat authentication system provides JWT tokens for authenticated requests.

6. **File Uploads**: The system supports file uploads through Directus integration, with images stored on Cloudinary CDN.
